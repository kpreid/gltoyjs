<!doctype html>
<html><head>
  <title>GLToyJS</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  
  <script type="text/javascript" src="deps/game-shim/game-shim.js"></script>
  <script type="text/javascript" src="deps/gl-matrix/gl-matrix.js"></script>
  <script type="text/javascript" src="deps/webgl-debug.js"></script>
  <script type="text/javascript" src="gltoy.js"></script>

  <script type="text/javascript">
    var exports = {};
    var effects = Object.create(null);
    function store(name) {
      effects[name] = exports;
      exports = {};
    }
  </script>
  <script type="text/javascript" src="effects/orchard/effect.js"></script>
  <script type="text/javascript">store("orchard")</script>
  <script type="text/javascript" src="effects/voronoi/effect.js"></script>
  <script type="text/javascript">store("voronoi")</script>
  
  <style type="text/css">
    html, body, canvas {
      display: block;
      margin: 0;
      border: none;
      padding: 0;
      width: 100%;
      height: 100%;
    }
    body {
      background: #777;
    }
    .overlay {
      position: absolute;
      font: status-bar;
      color: white;
      text-shadow: 0 0 .3em #000, 0 0 .3em #000;
      margin: .5em .5em;
      display: table;
      pointer-events: none;
    }
    .overlay pre { margin: 0; }
  </style>
  
  <script type="text/javascript">
    function gltoyMain() {
      var canvas = document.getElementById("canvas");
      var toy = new gltoy.EffectManager(canvas, effects);
      var currentEffectName; // TODO should be EffectManager's problem
      
      function switchEffect(name) {
        currentEffectName = name;
        var parameters = effects[name].configure();
        toy.switchEffect(name, parameters);

        var desc = name + " ";
        function prettyprint(o) {
          switch (typeof o) {
            case "object":
              desc += "{";
              var keys = Object.keys(o);
              if (keys.length === 1) {
                var key = keys[0];
                desc += " " + key + ": ";
                prettyprint(o[key]);
                desc += " ";
              } else if (keys.length > 0) {
                desc += "\n";
                keys.forEach(function (key) {
                  desc += "  " + key + ": ";
                  prettyprint(o[key]);
                  desc += "\n";
                });
              }
              desc += "}";
              break;
            default:
              desc += String(o);
              break;
          }
        }
        prettyprint(parameters);
        document.getElementById("state-display").textContent = desc;
      }
      
      function randomEffect() {
        var names = Object.keys(effects);
        switchEffect(names[Math.floor(Math.random() * names.length)]);
      }
      
      // --- ---
      
      document.addEventListener("keydown", function (event) {
        switch (String.fromCharCode(event.keyCode)) {
          case " ": randomEffect(); break;
          case "R":
            switchEffect(currentEffectName);
            break;
        }
      }, false);
      
      // --- setup ---
      
      randomEffect();      
      setInterval(randomEffect, 1000 * 60 * 5);
    }
  </script>
</head>
<body onload="gltoyMain();">
  <canvas id="canvas"></canvas>
  
  <div style="top: 0; left: 0;" class="overlay">
    <pre id="state-display"></pre>
  </div>
</body>
</html>
